<html>
  <head>
	<title>Lightning Peep Show</title>
  </head>
  <body>
	<canvas id="canvas" width="350" height="225"></canvas>
	<button id="invoice">Go</button>
	This invoice expires in 60 minutes. (add countdown timer)
	<div id="payreq"></div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script>
	var websocketAddress = "ws://localhost:54018/?r_hash=";
	var c = document.getElementById("canvas");
	var ctx = c.getContext("2d");

    $("#invoice").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "GET",
            url: '/invoice',
            dataType: "json",
            success: function(res) {
        	  var response = JSON.parse(res)
        	  console.log(response)

              $("#payreq").text(response.payment_request);
              var lntb = "lightning:" + response.payment_request;
              var lnHTML = '<center><img src="https://chart.googleapis.com/chart?chs=200x200&cht=qr&chld=M|0&chl=' + lntb + '"></center>';
              //$('#qrcode').html(lnHTML);
              //$('#pay').attr('href', lntb);
		  	  
		  	  var websocket = new WebSocket(websocketAddress + encodeURIComponent(response.r_hash));

			  websocket.onopen = function () {
				console.log("mjpeg-relay connected");
			  };

			  websocket.onclose = function () {
				console.log("mjpeg-relay disconnected");
			  };

	  		  websocket.onmessage = function (event) {
	  		  	// console.log(event)
				var image = new Image();
				image.onload = function () {
			      ctx.drawImage(image, 0, 0);
				};
				image.src = event.data;
			  };

			  websocket.onerror = function (event) {
				console.log('error: ' + event.data);
				websocket.close();
			  };

            }
        });
    })			
	</script>
  </body>
</html>
