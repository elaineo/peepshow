<html>
  <head>
	<title>Lightning Peep Show</title>
  </head>
  <body>
	<canvas id="canvas" width="350" height="225"></canvas>
	<button id="invoice">Go</button>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script>
	var websocketAddress = "ws://45.76.1.186:54018/lnsocket?r_hash=";
	var c = document.getElementById("canvas");
	var ctx = c.getContext("2d");


    $("#invoice").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: '/invoice',
            success: function(response) {
              console.log(response);
              if ("error" in response) {
                $("div#failBody").html(response.error);
                $("#errorModal").modal("show");
                return;
              }
              $("#payreq").text(response.invoice);
              var lntb = "lightning:" + response.invoice;
              var lnHTML = '<center><img src="https://chart.googleapis.com/chart?chs=200x200&cht=qr&chld=M|0&chl=' + lntb + '"></center>';
              $('#qrcode').html(lnHTML);
              $('#pay').attr('href', lntb);
		  	  
		  	  var websocket = new WebSocket(websocketAddress + encodeURIComponent(response.r_hash));

			  websocket.onopen = function () {
				console.log("mjpeg-relay connected");
			  };

			  websocket.onclose = function () {
				console.log("mjpeg-relay disconnected");
			  };

	  		  websocket.onmessage = function (event) {
				var image = new Image();
				image.onload = function () {
			      ctx.drawImage(image, 0, 0);
				};
				image.src = evt.data;
			  };

			  websocket.onerror = function (evt) {
				console.log('error: ' + evt.data);
				websocket.close();
			  };

            }
        });
    })			
	</script>
  </body>
</html>
